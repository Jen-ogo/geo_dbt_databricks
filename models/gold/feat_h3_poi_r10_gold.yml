version: 2

models:
  - name: feat_h3_poi_r10_gold
    description: >
      GOLD POI feature mart on H3 R10 (Databricks).
      Reuses SILVER.FEAT_H3_POI_R10 (POI points + POI areas already unioned and aggregated in SILVER),
      without re-aggregating and without recomputing H3/cell geometry in GOLD.
      GOLD normalizes NULL counts to 0 and adds density metrics per km² using cell_area_m2.

      Grain: (region_code, region, h3_r10), where h3_r10 is canonical hex STRING.

    tests:
      - rowcount_gt_0:
          config:
            name: feat_h3_poi_r10_gold__rowcount_gt_0

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, region, h3_r10]
          config:
            name: feat_h3_poi_r10_gold__uk_region_region_h3

    columns:
      - name: region_code
        description: "Country/region code used across the project (e.g., poland, germany)."
        tests: [not_null]

      - name: region
        description: "Administrative region name within region_code (e.g., voivodeship/state) as in SILVER."
        tests: [not_null]

      - name: h3_r10
        description: "H3 index at resolution 10 as canonical hex STRING."
        tests:
          - not_null
          - is_h3_hex:
              config:
                name: feat_h3_poi_r10_gold__h3_r10_is_h3_hex

      - name: cell_area_m2
        description: >
          Area of the H3 cell polygon in square meters (m²), provided from SILVER.DIM_H3_R10_CELLS.
          Used for density metrics per km².
        tests:
          - not_null
          - non_negative:
              column_name: cell_area_m2

      - name: cell_wkt_4326
        description: "H3 cell boundary WKT in EPSG:4326 (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              column_name: cell_wkt_4326
          - wkt_prefix_any:
              column_name: cell_wkt_4326
              prefixes: ["POLYGON", "MULTIPOLYGON"]

      - name: cell_center_wkt_4326
        description: "H3 cell center point WKT in EPSG:4326 (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              column_name: cell_center_wkt_4326
          - wkt_prefix_any:
              column_name: cell_center_wkt_4326
              prefixes: ["POINT"]

      - name: poi_cnt
        description: >
          Total POI count in the H3 cell (points + areas combined), from SILVER aggregation.
          In GOLD NULL is normalized to 0 for empty cells.
        tests:
          - not_null
          - non_negative:
              column_name: poi_cnt

      - name: poi_amenity_cnt
        description: "Count of POIs where poi_class = 'amenity' in the cell (normalized to 0 in GOLD)."
        tests:
          - not_null
          - non_negative:
              column_name: poi_amenity_cnt

      - name: poi_shop_cnt
        description: "Count of POIs where poi_class = 'shop' in the cell (normalized to 0 in GOLD)."
        tests:
          - not_null
          - non_negative:
              column_name: poi_shop_cnt

      - name: poi_tourism_cnt
        description: "Count of POIs where poi_class = 'tourism' in the cell (normalized to 0 in GOLD)."
        tests:
          - not_null
          - non_negative:
              column_name: poi_tourism_cnt

      - name: poi_building_cnt
        description: "Count of POIs where poi_class = 'building' in the cell (normalized to 0 in GOLD)."
        tests:
          - not_null
          - non_negative:
              column_name: poi_building_cnt

      - name: poi_landuse_cnt
        description: "Count of POIs where poi_class = 'landuse' in the cell (normalized to 0 in GOLD)."
        tests:
          - not_null
          - non_negative:
              column_name: poi_landuse_cnt

      - name: poi_per_km2
        description: "POI density per km²: poi_cnt / (cell_area_m2 / 1e6)."
        tests:
          - non_negative:
              column_name: poi_per_km2

      - name: poi_amenity_per_km2
        description: "Amenity POI density per km²: poi_amenity_cnt / (cell_area_m2 / 1e6)."
        tests:
          - non_negative:
              column_name: poi_amenity_per_km2

      - name: poi_shop_per_km2
        description: "Shop POI density per km²: poi_shop_cnt / (cell_area_m2 / 1e6)."
        tests:
          - non_negative:
              column_name: poi_shop_per_km2

      - name: poi_tourism_per_km2
        description: "Tourism POI density per km²: poi_tourism_cnt / (cell_area_m2 / 1e6)."
        tests:
          - non_negative:
              column_name: poi_tourism_per_km2

      - name: last_load_ts
        description: >
          Latest load timestamp among contributing POI records in SILVER aggregation.
          Can be NULL for cells with zero POIs (left join behavior).