version: 2

models:
  - name: feat_h3_poi_points_r7
    description: >
      GOLD.FEAT_H3_POI_POINTS_R7 â€” POI points intensity features on the H3 resolution 7 grid for EV siting.

      Built directly in GOLD by aggregating SILVER.POI_POINTS into H3 R7 (hex STRING), then LEFT JOINing
      onto the full H3 grid from SILVER.DIM_H3_R7_CELLS to keep all cells (including empty ones).

      Grain: (region_code, region, h3_r7).
      last_load_ts is NULL for cells with zero POIs (expected).

    tests:
      - rowcount_gt_0:
          config:
            name: feat_h3_poi_points_r7__rowcount_gt_0

      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns: [region_code, region, h3_r7]
          config:
            name: feat_h3_poi_points_r7__uk_region_region_h3

    columns:
      - name: region_code
        tests: [not_null]

      - name: region
        tests: [not_null]

      - name: h3_r7
        tests:
          - not_null
          - is_h3_hex:
              arguments:
                column_name: h3_r7
              config:
                name: feat_h3_poi_points_r7__h3_r7_is_h3_hex

      - name: cell_area_m2
        tests:
          - not_null
          - non_negative:
              arguments:
                column_name: cell_area_m2
              config:
                name: feat_h3_poi_points_r7__cell_area_m2_non_negative

      - name: cell_wkt_4326
        tests:
          - not_null
          - wkt_not_empty:
              arguments:
                column_name: cell_wkt_4326
              config:
                name: feat_h3_poi_points_r7__cell_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                column_name: cell_wkt_4326
                prefixes: ["POLYGON", "MULTIPOLYGON"]
              config:
                name: feat_h3_poi_points_r7__cell_wkt_prefix_polygonal

      - name: cell_center_wkt_4326
        tests:
          - not_null
          - wkt_not_empty:
              arguments:
                column_name: cell_center_wkt_4326
              config:
                name: feat_h3_poi_points_r7__cell_center_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                column_name: cell_center_wkt_4326
                prefixes: ["POINT"]
              config:
                name: feat_h3_poi_points_r7__cell_center_wkt_prefix_point

      - name: poi_points_cnt
        tests:
          - not_null
          - non_negative:
              arguments:
                column_name: poi_points_cnt
              config:
                name: feat_h3_poi_points_r7__poi_points_cnt_non_negative

      - name: poi_classes_cnt
        tests:
          - not_null
          - non_negative:
              arguments:
                column_name: poi_classes_cnt
              config:
                name: feat_h3_poi_points_r7__poi_classes_cnt_non_negative

      - name: poi_types_cnt
        tests:
          - not_null
          - non_negative:
              arguments:
                column_name: poi_types_cnt
              config:
                name: feat_h3_poi_points_r7__poi_types_cnt_non_negative

      # buckets: keep light like in R10
      - name: parking_cnt
        tests:
          - non_negative:
              arguments:
                column_name: parking_cnt

      - name: mobility_services_cnt
        tests:
          - non_negative:
              arguments:
                column_name: mobility_services_cnt

      - name: poi_points_per_km2
        tests:
          - non_negative:
              arguments:
                column_name: poi_points_per_km2

      - name: parking_per_km2
        tests:
          - non_negative:
              arguments:
                column_name: parking_per_km2

      - name: mobility_services_per_km2
        tests:
          - non_negative:
              arguments:
                column_name: mobility_services_per_km2

      - name: poi_method
        tests:
          - values_in_or_null:
              arguments:
                column_name: poi_method
                values: ["poi_points_to_h3_r7"]
              config:
                name: feat_h3_poi_points_r7__poi_method_allowed