version: 2

models:
  - name: feat_h3_pop_r10
    description: >
      GOLD population features on H3 R10.
      Allocation from 1km census grid (admin4-scoped) to avoid duplication.
      Grain: (region_code, region, h3_r10).

    tests:
      - rowcount_gt_0:
          config:
            name: feat_h3_pop_r10__rowcount_gt_0

      - not_empty:
          config:
            name: feat_h3_pop_r10__not_empty

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, region, h3_r10]
          config:
            name: feat_h3_pop_r10__uk_region_h3

    columns:
      - name: region_code
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__region_code_not_null

      - name: region
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__region_not_null

      - name: h3_r10
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__h3_r10_not_null
          - is_h3_hex:
              arguments:
                column_name: h3_r10
              config:
                name: feat_h3_pop_r10__h3_r10_is_h3_hex

      - name: cell_area_m2
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__cell_area_m2_not_null
          - non_negative:
              arguments:
                column_name: cell_area_m2
              config:
                name: feat_h3_pop_r10__cell_area_m2_non_negative

      - name: cell_wkt_4326
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__cell_wkt_not_null
          - wkt_not_empty:
              arguments:
                column_name: cell_wkt_4326
              config:
                name: feat_h3_pop_r10__cell_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                column_name: cell_wkt_4326
                prefixes: ["POLYGON", "MULTIPOLYGON"]
              config:
                name: feat_h3_pop_r10__cell_wkt_prefix_poly

      - name: cell_center_wkt_4326
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__cell_center_wkt_not_null
          - wkt_not_empty:
              arguments:
                column_name: cell_center_wkt_4326
              config:
                name: feat_h3_pop_r10__cell_center_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                column_name: cell_center_wkt_4326
                prefixes: ["POINT"]
              config:
                name: feat_h3_pop_r10__cell_center_wkt_prefix_point

      - name: grid_cells_cnt
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__grid_cells_cnt_not_null
          - non_negative:
              arguments:
                column_name: grid_cells_cnt
              config:
                name: feat_h3_pop_r10__grid_cells_cnt_non_negative

      - name: pop_total
        tests:
          - non_negative:
              arguments:
                column_name: pop_total
              config:
                name: feat_h3_pop_r10__pop_total_non_negative

      - name: emp_total
        tests:
          - non_negative:
              arguments:
                column_name: emp_total
              config:
                name: feat_h3_pop_r10__emp_total_non_negative

      - name: pop_male
        tests:
          - non_negative:
              arguments:
                column_name: pop_male
              config:
                name: feat_h3_pop_r10__pop_male_non_negative

      - name: pop_female
        tests:
          - non_negative:
              arguments:
                column_name: pop_female
              config:
                name: feat_h3_pop_r10__pop_female_non_negative

      - name: pop_age_lt15
        tests:
          - non_negative:
              arguments:
                column_name: pop_age_lt15
              config:
                name: feat_h3_pop_r10__pop_age_lt15_non_negative

      - name: pop_age_1564
        tests:
          - non_negative:
              arguments:
                column_name: pop_age_1564
              config:
                name: feat_h3_pop_r10__pop_age_1564_non_negative

      - name: pop_age_ge65
        tests:
          - non_negative:
              arguments:
                column_name: pop_age_ge65
              config:
                name: feat_h3_pop_r10__pop_age_ge65_non_negative

      - name: share_age_ge65
        tests:
          - num_between_or_null:
              arguments:
                column_name: share_age_ge65
                min_value: 0
                max_value: 1
              config:
                name: feat_h3_pop_r10__share_age_ge65_0_1_warn
                severity: warn

      - name: share_age_lt15
        tests:
          - num_between_or_null:
              arguments:
                column_name: share_age_lt15
                min_value: 0
                max_value: 1
              config:
                name: feat_h3_pop_r10__share_age_lt15_0_1_warn
                severity: warn

      - name: share_emp
        tests:
          - num_between_or_null:
              arguments:
                column_name: share_emp
                min_value: 0
                max_value: 1
              config:
                name: feat_h3_pop_r10__share_emp_0_1_warn
                severity: warn

      - name: pop_method
        tests:
          - values_in_or_null:
              arguments:
                column_name: pop_method
                values: ["census_grid_1km_to_h3_allocated"]
              config:
                name: feat_h3_pop_r10__pop_method_allowed