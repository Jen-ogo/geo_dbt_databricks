version: 2

models:
  - name: activity_places
    description: >
      OSM buildings_activity cleaned to "places" (non-residential-ish), deduplicated by feature_id.
      Databricks Silver. Geometry: geom (SRID=4326) + geom_wkt_4326 (mandatory debug).
      Grain: 1 row per feature_id, latest by (load_ts desc, source_file desc).

    tests:
      - rowcount_gt_0:
          config:
            name: activity_places__rowcount_gt_0

      - osm_id_or_way_id_present:
          config:
            name: activity_places__osm_id_or_way_id_present

    columns:
      - name: feature_id
        description: "Stable key: 'N<osm_id>' or 'W<osm_way_id>'. Dedup key."
        tests: [not_null, unique]

      - name: osm_id
        description: "OSM node id (nullable for ways)."

      - name: osm_way_id
        description: "OSM way id (nullable for nodes)."

      - name: name
        description: "OSM name tag (nullable)."

      - name: name_en
        description: "OSM name:en parsed from tags (nullable)."

      - name: activity_class
        description: "High-level bucket: amenity/shop/office/tourism/leisure/sport/craft/building."
        tests:
          - not_null
          - values_in_or_null:
              arguments:
                column_name: activity_class
                values: ["amenity","shop","office","tourism","leisure","sport","craft","building"]
              config:
                name: activity_places__activity_class_allowlist

      - name: activity_type_lc
        description: "Lowercased activity type from the first non-null of tag families."
        tests: [not_null]

      - name: building_levels
        description: "Parsed building:levels (nullable, tolerant parsing)."
        tests:
          - non_negative:
              arguments:
                column_name: building_levels
              config:
                name: activity_places__building_levels_non_negative

      - name: operator_name
        description: "operator/network/brand (nullable)."

      - name: opening_hours
        description: "opening_hours tag (nullable)."

      - name: geom
        description: "Geometry as GEOMETRY, SRID=4326."
        tests: [not_null]

      - name: geom_wkt_4326
        description: "Mandatory debug WKT derived from geom."
        tests:
          - not_null
          - wkt_not_empty:
              arguments:
                column_name: geom_wkt_4326
              config:
                name: activity_places__geom_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                column_name: geom_wkt_4326
                prefixes: ["POLYGON(", "MULTIPOLYGON(", "POINT(", "LINESTRING("]
              config:
                name: activity_places__geom_wkt_prefix_any_geo

      - name: region_code
        description: "Canonical region/country code from ingest: lower(country)."
        tests: [not_null]

      - name: region
        description: "Region label from ingest partitioning."
        tests: [not_null]

      - name: source_file
        description: "Lineage + dedup tie-break."
        tests: [not_null]

      - name: load_ts
        description: "Load timestamp used for dedup ordering."
        tests: [not_null]